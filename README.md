# MiniGPTChess

Минимальная шахматная песочница, где ходы за ИИ выбирает модель GPT. Проект демонстрирует взаимодействие клиента на PyGame и сервера на FastAPI, использующего `python-chess` для проверки правил.

## Возможности

- Отрисовка доски с помощью PyGame.
- На краях доски отображается стандартная шахматная разметка.
- Фигуры отображаются Unicode-символами и окрашиваются по цвету сторон.
- Stateless сервер: клиент передает FEN и сторону хода в каждом запросе.
- Проверка ходов и генерация ответного хода на сервере.
- Подключение к OpenAI Responses API для выбора хода (переменная окружения `OPENAI_API_KEY`). При недоступности API используется случайный легальный ход.
- Валидация ходов через `validate_and_apply_move` и вычисление флагов состояния `compute_game_flags` (модуль `shared.chess`).
- Клиент выполняет локальную проверку ходов с помощью `python-chess` перед отправкой запроса.
- Клиент позволяет выбирать клетки мышью, отправлять ход на сервер и получать ответ ИИ.
- Легальный ход игрока сразу отображается на доске без ожидания ответа сервера.
- Выделение клетки можно снять правой кнопкой мыши; выбрать можно только свою фигуру.
- При достижении последней горизонтали пешка предлагает выбрать фигуру для превращения.

## Структура

```
client/     # PyGame интерфейс
server/app/ # FastAPI сервер и логика игры
shared/     # общие модули сервера и клиента
tests/      # тесты утилит
```

## Установка

```bash
pip install -r requirements-server.txt
pip install -r requirements-client.txt
```

## Переменные окружения

Сервер и клиент используют отдельные файлы конфигурации. Создайте их на основе примеров:

```bash
cp server/.env.example server/.env
cp client/.env.example client/.env
# в server/.env укажите OPENAI_API_KEY=<ваш ключ>
# в client/.env укажите SERVER_URL=http://<PUBLIC_IP>:<PORT>
```

`SERVER_URL` задаёт адрес сервера. Его можно хранить в `client/.env` или передавать при запуске.

Для включения подробных логов установите `DEBUG_LOGS=1` в нужном `.env`.

Для ограничения доступа по CORS укажите `CORS_ALLOW_ORIGINS` в `server/.env` со списком адресов через запятую. По умолчанию разрешены все источники.

## Запуск

### Сервер

```bash
uvicorn server.app:app --host 0.0.0.0 --port 8000
```
Сервер настроен с поддержкой CORS: по умолчанию API доступен с любого домена.
Список доменов можно ограничить переменной `CORS_ALLOW_ORIGINS`.

#### Эндпоинты

- `GET /health` — проверка работоспособности; возвращает `{ "status": "ok" }`.
- `POST /move` — применяет ход игрока и возвращает ход ИИ.

Пример запроса:

```json
{
  "fen": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
  "side": "w",
  "client_move": "e2e4"
}
```

Пример ответа:

```json
{
  "status": "ok",
  "applied_client_move": true,
  "ai_move": "c7c5",
  "new_fen": "...",
  "flags": {
    "check": false,
    "checkmate": false,
    "stalemate": false,
    "insufficient_material": false,
    "seventyfive_moves": false,
    "fivefold_repetition": false
  },
  "errors": []
}
```

При ошибках сервер возвращает код 200 и JSON с `status: "error"` и
заполненным списком `errors`.

### Коды ошибок

- `illegal_client_move` — клиент отправил некорректный или запрещённый ход;
- `no_legal_moves` — отсутствуют легальные ходы;
- `invalid_fen` — некорректная строка FEN;
- `side_to_move_mismatch` — указанная сторона не совпадает со стороной хода в FEN;
- `gpt_invalid_move` — модель GPT вернула недопустимый ход;
- `server_error` — внутренняя ошибка сервера.

### Ограничения

- Строка FEN в запросе ограничена **100** символами.
- Поле `client_move` принимает строки длиной не более **8** символов.
- При обращении к GPT выполняется не более **двух** повторных попыток; если
  корректный ход получить не удалось, выбирается случайный легальный ход.

### Клиент

```bash
SERVER_URL=http://<PUBLIC_IP>:<PORT> python client/main.py
```

Если адрес сервера указан в `client/.env`, достаточно выполнить `python client/main.py`.

Клиент отображает шахматную доску в стартовой позиции и взаимодействует с сервером для обмена ходами.

#### Сборка клиента

Чтобы передавать игру без исходников, соберите клиент в исполняемый файл при помощи [PyInstaller](https://pyinstaller.org/):

```bash
pip install pyinstaller
pyinstaller --onefile --name MiniGPTChess client/main.py
```

Готовый файл появится в каталоге `dist` (например, `dist/MiniGPTChess` или `MiniGPTChess.exe` на Windows). Передайте его вместе с этим каталогом и запускайте на машине, где уже работает сервер. Для получения папки с зависимостями используйте `pyinstaller --name MiniGPTChess client/main.py`; итоговая директория окажется в `dist/MiniGPTChess/`.

Файл `client/.env` необходимо разместить рядом с исполняемым файлом или добавить в сборку через `--add-data client/.env:.`.

При запуске укажите URL сервера:

```bash
SERVER_URL=http://<PUBLIC_IP>:<PORT> ./dist/MiniGPTChess
```

## Тестирование

Убедитесь, что установлен `pytest` (например, `pip install pytest`).

Запустить все тесты:

```bash
pytest
```

Тесты разделены по проектам:

```text
tests/
  client/  # тесты PyGame клиента
  server/  # тесты FastAPI сервера
```

Можно запускать тесты выборочно:

```bash
pytest tests/client   # только клиент
pytest tests/server   # только сервер
```

При изменении кода или добавлении новой функциональности добавляйте соответствующие тесты и сохраняйте эту структуру.
Тесты клиента и сервера автоматически запускаются в GitHub Actions при каждом push и pull request, результаты отображаются в PR.

## Конфигурации VSCode

В каталоге `.vscode` находится файл `launch.json` с конфигурациями для удобного запуска проекта.

- **Client** — старт клиента `client/main.py`.
- **Client Tests** — запуск тестов клиента с помощью `pytest`.
- **Server** — запуск сервера через `uvicorn server.main:app`.
- **Server Tests** — запуск тестов сервера.
